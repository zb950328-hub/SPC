<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级SPC分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="libs/chart.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <script src="libs/chart.min.js"></script>
    <link rel="stylesheet" href="libs/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --bg-light: #f1faee;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7ec 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center; /* 居中内容 */
        }

        .app-container {
            width: 1600px; /* 固定宽度 */
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            position: relative;
            overflow: hidden;
            flex: 1;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .app-header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

        .app-title {
            color: var(--dark);
            margin: 0 0 10px;
            font-size: 2.4rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: #ffffff;
            border-radius: 14px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: none;
            transition: var(--transition);
            width: 100%;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--dark);
            margin: 0;
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .card-title i {
            margin-right: 10px;
            color: var(--primary);
            font-size: 1.2em;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .control-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: #fafbfc;
            transition: var(--transition);
            min-width: 150px;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            border: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3aafd6;
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d61a6b;
            box-shadow: 0 4px 12px rgba(247, 37, 133, 0.3);
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover {
            background: #3a7bd5;
            box-shadow: 0 4px 12px rgba(72, 149, 239, 0.3);
        }

        .btn-excel {
            background: #1d6f42;
            color: white;
        }

        .btn-excel:hover {
            background: #165a34;
            box-shadow: 0 4px 12px rgba(29, 111, 66, 0.3);
        }

        .data-table-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-top: 15px;
            width: 100%;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed; /* 固定表格布局 */
        }

        .data-table th {
            background-color: var(--primary);
            color: white;
            padding: 14px 10px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: #fff;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background-color: rgba(67, 97, 238, 0.03);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 20px;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .rule-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            height: 100%;
        }

        .rule-card h4 {
            margin: 0 0 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }

        .rule-card h4 i {
            margin-right: 10px;
            color: var(--primary);
        }

        .rule-card p {
            margin: 0 0 15px;
            color: #555;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .rule-examples {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .rule-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .rule-1 { background-color: #e74c3c; }
        .rule-2 { background-color: #9b59b6; }
        .rule-3 { background-color: #f39c12; }
        .rule-4 { background-color: #1abc9c; }
        .rule-5 { background-color: #d35400; }
        .rule-6 { background-color: #2c3e50; }
        .rule-7 { background-color: #7f8c8d; }
        .rule-8 { background-color: #c0392b; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.4s ease;
            display: flex;
            align-items: center;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .tab-container {
            margin-bottom: 25px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 600;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-cell {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .input-cell:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-cell:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .column-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .help-text {
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .serial-col {
            width: 80px;
            text-align: center;
            font-weight: bold;
        }

        .data-col {
            width: 120px; /* 固定列宽 */
        }

        .action-col {
            width: 100px;
        }

        .rule-violation {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.8rem;
            margin: 2px;
        }

        .column-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: var(--gray);
            font-size: 0.9rem;
            width: 1600px; /* 与app-container同宽 */
        }

        @media (max-width: 1650px) {
            .app-container, footer {
                width: 95%; /* 在小屏幕上使用百分比宽度 */
                max-width: 1600px;
            }
        }

        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .rules-grid {
                grid-template-columns: 1fr;
            }

            .data-col {
                width: 100px; /* 小屏幕上减小列宽 */
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .app-title {
                font-size: 1.8rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .data-col {
                width: 80px; /* 更小屏幕上进一步减小列宽 */
            }
        }

        /* 本地库状态卡片样式 */
        .lib-status-card {
            background: #ffffff;
            border-radius: 14px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            border-left: 4px solid #4361ee;
            transition: all 0.3s ease;
        }
        
        .lib-status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .lib-status-title {
            font-size: 1.3rem;
            color: #212529;
            margin: 0;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        .lib-status-title i {
            margin-right: 10px;
            color: #4361ee;
            font-size: 1.2em;
            }
        
        .toggle-status-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .toggle-status-btn:hover {
            background: #3a53c7;
        }
        
        .status-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .status-item:hover {
            background: #e9ecef;
        }
        
        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .status-ok {
            background-color: #4cc9f0;
            color: white;
        }
        
        .status-error {
            background-color: #e63946;
            color: white;
        }
        
        .status-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .status-info {
            background-color: #4895ef;
            color: white;
        }
        
        .status-text {
            flex: 1;
            font-size: 1rem;
            }
        
        .status-version {
            color: #6c757d;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        .status-description {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
            margin-left: 39px;
        }

        /* 判异规则选择器样式 */
        .rules-selector-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .rule-selector-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rule-selector-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .rule-selector-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
        }

        .lock-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .lock-btn:hover {
            background: #5a6268;
        }

        .lock-btn.locked {
            background: #28a745;
        }

        .lock-btn.locked:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">AI数据分析——SPC统计过程控制</h1>
        </header>
        
        <div class="control-panel">
            <div class="control-group">
                <label class="control-label">上规格限 (USL)</label>
                <input type="number" id="usl" class="control-input" step="0.01" placeholder="USL">
            </div>
            
            <div class="control-group">
                <label class="control-label">下规格限 (LSL)</label>
                <input type="number" id="lsl" class="control-input" step="0.01" placeholder="LSL">
            </div>
            
            <div class="control-group">
                <label class="control-label">选择分析列</label>
                <select id="data-column-select" class="control-input">
                    <!-- 列选项将通过JavaScript动态生成 -->
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">数据列数</label>
                <div class="column-controls">
                    <button id="decrease-cols" class="btn btn-info">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span id="col-count" style="padding: 0 10px; display: flex; align-items: center;">5</span>
                    <button id="increase-cols" class="btn btn-info">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-table"></i>数据输入表</h2>
                    <div>
                        <button id="add-row-btn" class="btn btn-success">
                            <i class="fas fa-plus"></i>添加行
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="input-table">
                        <thead id="table-head">
                            <tr>
                                <th class="serial-col">序号</th>
                                <!-- 数据列将通过JavaScript动态生成 -->
                                <th class="action-col">操作</th>
                                <th class="action-col">锁定</th>
                            </tr>
                        </thead>
                        <tbody id="input-table-body">
                            <!-- 数据行将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button id="clear-btn" class="btn btn-danger">
                        <i class="fas fa-trash"></i>清除数据
                    </button>
                    <button id="export-excel" class="btn btn-excel">
                        <i class="fas fa-file-excel"></i>导出Excel
                    </button>
                    <div class="file-input-wrapper">
                        <button class="btn btn-excel">
                            <i class="fas fa-file-import"></i>导入Excel
                        </button>
                        <input type="file" id="excel-file" accept=".xlsx, .xls">
                    </div>
                </div>
            </div>

        <!-- 判异规则选择器 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-filter"></i>判异规则选择</h2>
            </div>
            <div class="rules-selector-container" id="rules-selector">
                <!-- 判异规则将通过JavaScript动态生成 -->
            </div>
        </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i>分析概览</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">数据点数</div>
                        <div class="stat-value" id="stat-data-points">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">平均值 (CL)</div>
                        <div class="stat-value" id="stat-mean">0.000</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">上控制限 (UCL)</div>
                        <div class="stat-value" id="stat-ucl">0.000</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">下控制限 (LCL)</div>
                        <div class="stat-value" id="stat-lcl">0.000</div>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="results">分析结果</div>
                        <div class="tab" data-tab="violations">异常点</div>
                    </div>
                    
                    <div class="tab-content active" id="results-tab">
                        <div id="results-container">
                            <p>输入数据后分析结果将显示在这里。</p>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="violations-tab">
                        <div id="violations-container">
                            <p>异常点将显示在这里。</p>
                        </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-line"></i>单值控制图 (I-Chart)</h2>
                </div>
                <div class="chart-container">
                    <canvas id="i-chart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-area"></i>移动极差控制图 (MR-Chart)</h2>
                </div>
                <div class="chart-container">
                    <canvas id="mr-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-search"></i>控制图八大判异原则</h2>
            </div>
            
            <div class="rules-grid">
                <div class="rule-card">
                    <h4><i class="fas fa-1"></i> 规则1: 点在控制限外</h4>
                    <p>任何点超出控制上限(UCL)或控制下限(LCL)</p>
                    <div class="rule-examples">
                        <div class="rule-dot rule-1">1</div>
                        <div class="rule-dot" style="background:#3498db;">N</div>
                        <div class="rule-dot" style="background:#3498db;">N</div>
                        <div class="rule-dot rule-1">1</div>
                        <div class="rule-dot" style="background:#3498db;">N</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-2"></i> 规则2: 连续9点同侧</h4>
                    <p>连续9个点在中心线(CL)的同一侧</p>
                    <div class="rule-examples">
                        <div class="rule-dot rule-2">2</div>
                        <div class="rule-dot rule-2">2</div>
                        <div class="rule-dot rule-2">2</div>
                        <div class="rule-dot rule-2">2</div>
                        <div class="rule-dot rule-2">2</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-3"></i> 规则3: 连续6点上升/下降</h4>
                    <p>连续6个点持续上升或持续下降</p>
                    <div class="rule-examples">
                        <div class="rule-dot" style="background:#3498db;">1</div>
                        <div class="rule-dot" style="background:#3498db;">2</div>
                        <div class="rule-dot" style="background:#3498db;">3</div>
                        <div class="rule-dot" style="background:#3498db;">4</div>
                        <div class="rule-dot rule-3">5</div>
                        <div class="rule-dot rule-3">6</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-4"></i> 规则4: 连续14点交替</h4>
                    <p>连续14个点上下交替变化</p>
                    <div class="rule-examples">
                        <div class="rule-dot" style="background:#3498db;">高</div>
                        <div class="rule-dot" style="background:#3498db;">低</div>
                        <div class="rule-dot" style="background:#3498db;">高</div>
                        <div class="rule-dot" style="background:#3498db;">低</div>
                        <div class="rule-dot rule-4">高</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-5"></i> 规则5: 3点中2点在2σ外</h4>
                    <p>连续3点中有2点在同侧的2σ区域外</p>
                    <div class="rule-examples">
                        <div class="rule-dot rule-5">A</div>
                        <div class="rule-dot" style="background:#3498db;">B</div>
                        <div class="rule-dot rule-5">A</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-6"></i> 规则6: 5点中4点在1σ外</h4>
                    <p>连续5点中有4点在同侧的1σ区域外</p>
                    <div class="rule-examples">
                        <div class="rule-dot rule-6">A</div>
                        <div class="rule-dot rule-6">A</div>
                        <div class="rule-dot" style="background:#3498db;">B</div>
                        <div class="rule-dot rule-6">A</div>
                        <div class="rule-dot rule-6">A</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-7"></i> 规则7: 15点在1σ内</h4>
                    <p>连续15个点全部在1σ区域内</p>
                    <div class="rule-examples">
                        <div class="rule-dot rule-7">7</div>
                        <div class="rule-dot rule-7">7</div>
                        <div class="rule-dot rule-7">7</div>
                        <div class="rule-dot rule-7">7</div>
                        <div class="rule-dot rule-7">7</div>
                    </div>
                </div>
                
                <div class="rule-card">
                    <h4><i class="fas fa-8"></i> 规则8: 8点在1σ外</h4>
                    <p>连续8个点全部在1σ区域外</p>
                    <div class="rule-examples">
                        <div class="rule-dot rule-8">8</div>
                        <div class="rule-dot rule-8">8</div>
                        <div class="rule-dot rule-8">8</div>
                        <div class="rule-dot rule-8">8</div>
                        <div class="rule-dot rule-8">8</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加本地库状态卡片 -->
    <div class="lib-status-card">
        <div class="lib-status-header">
            <h3 class="lib-status-title"><i class="fas fa-plug"></i> 库文件加载状态</h3>
            <button class="toggle-status-btn" id="toggle-status-btn">隐藏</button>
        </div>
        
        <ul class="status-list" id="lib-status-list">
            <li class="status-item">
                <span class="status-icon" id="xlsx-status">?</span>
                <span class="status-text">SheetJS (Excel处理)</span>
                <span class="status-version" id="xlsx-version"></span>
                <div class="status-description">用于Excel文件的导入和导出功能</div>
            </li>
            <li class="status-item">
                <span class="status-icon" id="chartjs-status">?</span>
                <span class="status-text">Chart.js (图表库)</span>
                <span class="status-version" id="chartjs-version"></span>
                <div class="status-description">用于绘制控制图和数据分析可视化</div>
            </li>
            <li class="status-item">
                <span class="status-icon" id="fontawesome-status">?</span>
                <span class="status-text">Font Awesome (图标库)</span>
                <span class="status-version" id="fontawesome-version"></span>
                <div class="status-description">提供界面图标和视觉元素</div>
            </li>
        </ul>
    </div>

    <footer>
        <p>AI数据分析——SPC统计过程控制 &copy; 2025 | 金海食品——张博</p>
         <p style="margin-top: 10px; font-size: 0.9em;">注意：离线状态下请确保libs文件夹与HTML文件在同一目录</p>
    </footer>
    
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i> 分析已完成，发现 <span id="outlier-count">0</span> 个异常点！
    </div>

    <script>
        // 全局变量
        let dataPoints = [];
        let iChart = null;
        let mrChart = null;
        let usl = null;
        let lsl = null;
        let currentColumn = "data1"; // 默认分析第一列数据
        let columnCount = 5; // 默认列数
        let enabledRules = [1]; // 默认启用所有判异规则
        let lockedRows = new Set(); // 存储被锁定的行索引
        
        // DOM 元素
        const inputTableBody = document.getElementById('input-table-body');
        const tableHead = document.getElementById('table-head');
        const addRowBtn = document.getElementById('add-row-btn');
        const clearBtn = document.getElementById('clear-btn');
        const exportExcelBtn = document.getElementById('export-excel');
        const excelFileInput = document.getElementById('excel-file');
        const dataColumnSelect = document.getElementById('data-column-select');
        const uslInput = document.getElementById('usl');
        const lslInput = document.getElementById('lsl');
        const resultsContainer = document.getElementById('results-container');
        const violationsContainer = document.getElementById('violations-container');
        const notification = document.getElementById('notification');
        const colCountDisplay = document.getElementById('col-count');
        const decreaseColsBtn = document.getElementById('decrease-cols');
        const increaseColsBtn = document.getElementById('increase-cols');
        const rulesSelector = document.getElementById('rules-selector');
        
        // 统计元素
        const statDataPoints = document.getElementById('stat-data-points');
        const statMean = document.getElementById('stat-mean');
        const statUcl = document.getElementById('stat-ucl');
        const statLcl = document.getElementById('stat-lcl');
        
        // 标签切换
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 事件监听器
            addRowBtn.addEventListener('click', addDataRow);
            clearBtn.addEventListener('click', clearData);
            exportExcelBtn.addEventListener('click', exportToExcel);
            excelFileInput.addEventListener('change', importFromExcel);
            dataColumnSelect.addEventListener('change', function() {
                currentColumn = this.value;
                calculateControlLimits();
            });
            
            // 列数控制
            decreaseColsBtn.addEventListener('click', () => changeColumnCount(-1));
            increaseColsBtn.addEventListener('click', () => changeColumnCount(1));
            
            // 标签切换事件
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // 添加active类到当前标签和内容
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // 数据输入事件 - 实时计算
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('data-input') || 
                    e.target.classList.contains('header-input') ||
                    e.target === uslInput || 
                    e.target === lslInput) {
                    debounce(calculateControlLimits, 500)();
                }
            });
            
            // 初始化判异规则选择器
            initRulesSelector();
            
            // 初始化表格和下拉菜单
            updateColumnCount();
            
            // 初始化图表
            initCharts();
            
            // 添加初始行
            addDataRow();
            addDataRow();
        });
        
        // 初始化判异规则选择器
        function initRulesSelector() {
            const rules = [
                { id: 1, name: "规则1: 点在控制限外" },
                { id: 2, name: "规则2: 连续9点同侧" },
                { id: 3, name: "规则3: 连续6点上升/下降" },
                { id: 4, name: "规则4: 连续14点交替" },
                { id: 5, name: "规则5: 3点中2点在2σ外" },
                { id: 6, name: "规则6: 5点中4点在1σ外" },
                { id: 7, name: "规则7: 15点在1σ内" },
                { id: 8, name: "规则8: 8点在1σ外" }
            ];
            
            let html = '';
            rules.forEach(rule => {
                html += `
                    <div class="rule-selector-item">
                        <input type="checkbox" id="rule-${rule.id}" class="rule-selector-checkbox" ${rule.id === 1 ? 'checked' : ''}>
                        <label for="rule-${rule.id}" class="rule-selector-label">${rule.name}</label>
                    </div>
                `;
            });
            
            rulesSelector.innerHTML = html;
            
            // 添加事件监听器
            document.querySelectorAll('.rule-selector-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const ruleId = parseInt(this.id.split('-')[1]);
                    
                    if (this.checked) {
                        // 添加规则
                        if (!enabledRules.includes(ruleId)) {
                            enabledRules.push(ruleId);
                        }
                    } else {
                        // 移除规则
                        enabledRules = enabledRules.filter(id => id !== ruleId);
                    }
                    
                    // 重新计算
                    calculateControlLimits();
                });
            });
        }
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 更改列数
        function changeColumnCount(delta) {
            const newCount = columnCount + delta;
            if (newCount >= 1 && newCount <= 20) {
                columnCount = newCount;
                updateColumnCount();
            }
        }
        
        // 更新列数
        function updateColumnCount() {
            colCountDisplay.textContent = columnCount;
            
            // 更新表头
            updateTableHeader();
            
            // 更新数据行
            updateTableRows();
            
            // 更新列选择下拉菜单
            updateColumnSelect();
            
            // 重新计算
            calculateControlLimits();
        }
        
        // 更新表头
        function updateTableHeader() {
            let headerHTML = '<th class="serial-col">序号</th>';
            
            for (let i = 1; i <= columnCount; i++) {
                headerHTML += `
                    <th class="data-col">
                        <input type="text" class="input-cell header-input" value="数据列${i}" data-col="data${i}">
                    </th>
                `;
            }
            
            headerHTML += '<th class="action-col">操作</th>';
            headerHTML += '<th class="action-col">锁定</th>';
            
            tableHead.querySelector('tr').innerHTML = headerHTML;
            
            // 添加列名编辑事件
            document.querySelectorAll('.header-input').forEach(input => {
                input.addEventListener('change', function() {
                    const col = this.getAttribute('data-col');
                    const option = document.querySelector(`#data-column-select option[value="${col}"]`);
                    if (option) {
                        option.textContent = this.value;
                    }
                    
                    // 如果当前选中的列被编辑，更新下拉菜单显示
                    if (currentColumn === col) {
                        dataColumnSelect.querySelector('option:checked').textContent = this.value;
                    }
                });
            });
        }
        
        // 更新表格行
        function updateTableRows() {
            const rows = inputTableBody.querySelectorAll('tr');
            
            rows.forEach((row, rowIndex) => {
                const isLocked = lockedRows.has(rowIndex);
                let rowHTML = `<td class="serial-col">${row.querySelector('.serial-col').textContent}</td>`;
                
                for (let i = 1; i <= columnCount; i++) {
                    const colName = `data${i}`;
                    const existingInput = row.querySelector(`.data-input[data-col="${colName}"]`);
                    const value = existingInput ? existingInput.value : '';
                    
                    rowHTML += `
                        <td>
                            <input type="number" step="0.01" class="input-cell data-input" 
                                   data-col="${colName}" value="${value}" placeholder="值" ${isLocked ? 'disabled' : ''}>
                        </td>
                    `;
                }
                
                rowHTML += `
                    <td>
                        <button class="btn btn-danger delete-row-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    <td>
                        <button class="lock-btn ${isLocked ? 'locked' : ''}" data-row="${rowIndex}">
                            ${isLocked ? '解锁' : '锁定'}
                        </button>
                    </td>
                `;
                
                row.innerHTML = rowHTML;
                
                // 添加删除行事件
                const deleteBtn = row.querySelector('.delete-row-btn');
                deleteBtn.addEventListener('click', function() {
                    if (inputTableBody.children.length > 1) {
                        // 更新锁定行索引
                        const newLockedRows = new Set();
                        lockedRows.forEach(lockedIndex => {
                            if (lockedIndex < rowIndex) {
                                newLockedRows.add(lockedIndex);
                            } else if (lockedIndex > rowIndex) {
                                newLockedRows.add(lockedIndex - 1);
                            }
                        });
                        lockedRows = newLockedRows;
                        
                        row.remove();
                        updateSerialNumbers();
                        calculateControlLimits();
                    } else {
                        showNotification("至少需要保留一行数据", "warning");
                    }
                });
                
                // 添加锁定行事件
                const lockBtn = row.querySelector('.lock-btn');
                lockBtn.addEventListener('click', function() {
                    const rowIndex = parseInt(this.getAttribute('data-row'));
                    
                    if (lockedRows.has(rowIndex)) {
                        // 解锁行
                        lockedRows.delete(rowIndex);
                        this.classList.remove('locked');
                        this.textContent = '锁定';
                        
                        // 启用该行的所有输入框
                        row.querySelectorAll('.data-input').forEach(input => {
                            input.disabled = false;
                        });
                    } else {
                        // 锁定行
                        lockedRows.add(rowIndex);
                        this.classList.add('locked');
                        this.textContent = '解锁';
                        
                        // 禁用该行的所有输入框
                        row.querySelectorAll('.data-input').forEach(input => {
                            input.disabled = true;
                        });
                    }
                });
                
                // 添加回车键跳转功能
                row.querySelectorAll('.data-input').forEach((input, index, inputs) => {
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            
                            // 找到下一个输入框
                            let nextInput;
                            if (index < inputs.length - 1) {
                                // 同一行的下一个输入框
                                nextInput = inputs[index + 1];
                            } else {
                                // 下一行的第一个输入框
                                const nextRow = row.nextElementSibling;
                                if (nextRow) {
                                    nextInput = nextRow.querySelector('.data-input');
                                } else {
                                    // 如果没有下一行，添加新行并聚焦到第一个输入框
                                    const newRow = addDataRow();
                                    setTimeout(() => {
                                        newRow.querySelector('.data-input').focus();
                                    }, 10);
                                    return;
                                }
                            }
                            
                            // 聚焦到下一个输入框
                            if (nextInput && !nextInput.disabled) {
                                nextInput.focus();
                                nextInput.select();
                            }
                        }
                    });
                });
            });
        }
        
        // 更新列选择下拉菜单
        function updateColumnSelect() {
            dataColumnSelect.innerHTML = '';
            
            for (let i = 1; i <= columnCount; i++) {
                const colName = `data${i}`;
                const headerInput = document.querySelector(`.header-input[data-col="${colName}"]`);
                const displayName = headerInput ? headerInput.value : `数据列${i}`;
                
                const option = document.createElement('option');
                option.value = colName;
                option.textContent = displayName;
                
                if (i === 1) {
                    option.selected = true;
                    currentColumn = colName;
                }
                
                dataColumnSelect.appendChild(option);
            }
        }
        
        // 添加数据行
        function addDataRow() {
            const rowCount = inputTableBody.querySelectorAll('tr').length;
            const row = document.createElement('tr');
            const rowIndex = rowCount;
            
            let rowHTML = `<td class="serial-col">${rowCount + 1}</td>`;
            
            for (let i = 1; i <= columnCount; i++) {
                rowHTML += `
                    <td>
                        <input type="number" step="0.01" class="input-cell data-input" 
                               data-col="data${i}" placeholder="值">
                    </td>
                `;
            }
            
            rowHTML += `
                <td>
                    <button class="btn btn-danger delete-row-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
                <td>
                    <button class="lock-btn" data-row="${rowIndex}">
                        锁定
                    </button>
                </td>
            `;
            
            row.innerHTML = rowHTML;
            inputTableBody.appendChild(row);
            
            // 添加删除行事件
            const deleteBtn = row.querySelector('.delete-row-btn');
            deleteBtn.addEventListener('click', function() {
                if (inputTableBody.children.length > 1) {
                    // 更新锁定行索引
                    const rowIndex = parseInt(row.querySelector('.lock-btn').getAttribute('data-row'));
                    const newLockedRows = new Set();
                    lockedRows.forEach(lockedIndex => {
                        if (lockedIndex < rowIndex) {
                            newLockedRows.add(lockedIndex);
                        } else if (lockedIndex > rowIndex) {
                            newLockedRows.add(lockedIndex - 1);
                        }
                    });
                    lockedRows = newLockedRows;
                    
                    row.remove();
                    updateSerialNumbers();
                    calculateControlLimits();
                } else {
                    showNotification("至少需要保留一行数据", "warning");
                }
            });
            
            // 添加锁定行事件
            const lockBtn = row.querySelector('.lock-btn');
            lockBtn.addEventListener('click', function() {
                const rowIndex = parseInt(this.getAttribute('data-row'));
                
                if (lockedRows.has(rowIndex)) {
                    // 解锁行
                    lockedRows.delete(rowIndex);
                    this.classList.remove('locked');
                    this.textContent = '锁定';
                    
                    // 启用该行的所有输入框
                    row.querySelectorAll('.data-input').forEach(input => {
                        input.disabled = false;
                    });
                } else {
                    // 锁定行
                    lockedRows.add(rowIndex);
                    this.classList.add('locked');
                    this.textContent = '解锁';
                    
                    // 禁用该行的所有输入框
                    row.querySelectorAll('.data-input').forEach(input => {
                        input.disabled = true;
                    });
                }
            });
            
            // 添加回车键跳转功能
            row.querySelectorAll('.data-input').forEach((input, index, inputs) => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        
                        // 找到下一个输入框
                        let nextInput;
                        if (index < inputs.length - 1) {
                            // 同一行的下一个输入框
                            nextInput = inputs[index + 1];
                        } else {
                            // 下一行的第一个输入框
                            const nextRow = row.nextElementSibling;
                            if (nextRow) {
                                nextInput = nextRow.querySelector('.data-input');
                            } else {
                                // 如果没有下一行，添加新行并聚焦到第一个输入框
                                const newRow = addDataRow();
                                setTimeout(() => {
                                    newRow.querySelector('.data-input').focus();
                                }, 10);
                                return;
                            }
                        }
                        
                        // 聚焦到下一个输入框
                        if (nextInput && !nextInput.disabled) {
                            nextInput.focus();
                            nextInput.select();
                        }
                    }
                });
            });
            
            return row;
        }
        
        // 更新序号
        function updateSerialNumbers() {
            const rows = inputTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.querySelector('.serial-col').textContent = index + 1;
                // 更新锁定按钮的data-row属性
                const lockBtn = row.querySelector('.lock-btn');
                if (lockBtn) {
                    lockBtn.setAttribute('data-row', index);
                    
                    // 更新锁定行索引
                    if (lockedRows.has(parseInt(lockBtn.getAttribute('data-row')))) {
                        lockedRows.delete(parseInt(lockBtn.getAttribute('data-row')));
                        lockedRows.add(index);
                    }
                }
            });
        }
        
        // 初始化图表
        function initCharts() {
            const iCtx = document.getElementById('i-chart').getContext('2d');
            const mrCtx = document.getElementById('mr-chart').getContext('2d');
            
            // 单值控制图配置
            iChart = new Chart(iCtx, {
                type: 'line',
                data: {
                    labels: [], // 初始为空，将在更新时填充
                    datasets: [{
                        label: '数据点',
                        data: [],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.1,
                        fill: true
                    }, {
                        label: '中心线 (CL)',
                        data: [],
                        borderColor: '#2ecc71',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: '上控制限 (UCL)',
                        data: [],
                        borderColor: '#f39c12',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: '下控制限 (LCL)',
                        data: [],
                        borderColor: '#f39c12',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: '上规格限 (USL)',
                        data: [],
                        borderColor: '#9b59b6',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: '下规格限 (LSL)',
                        data: [],
                        borderColor: '#9b59b6',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '测量值',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '样本序号',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(3);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 500,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // 移动极差控制图配置
            mrChart = new Chart(mrCtx, {
                type: 'line',
                data: {
                    labels: [], // 初始为空，将在更新时填充
                    datasets: [{
                        label: '移动极差',
                        data: [],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.1,
                        fill: true
                    }, {
                        label: '中心线 (MR)',
                        data: [],
                        borderColor: '#2ecc71',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: '上控制限 (UCL)',
                        data: [],
                        borderColor: '#f39c12',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '移动极差值',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: 0,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '样本序号',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(3);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    animation: {
                        duration: 500,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
        
        // 计算控制限
        function calculateControlLimits() {
            // 获取输入数据
            dataPoints = [];
            
            const rows = inputTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const dataInput = row.querySelector(`.data-input[data-col="${currentColumn}"]`);
                
                if (dataInput && dataInput.value) {
                    dataPoints.push(parseFloat(dataInput.value));
                }
            });
            
            if (dataPoints.length < 2) {
                resultsContainer.innerHTML = '<p>需要至少2个数据点才能计算移动极差</p>';
                // 清除图表数据
                clearCharts();
                return;
            }
            
            // 获取规格限
            usl = uslInput.value ? parseFloat(uslInput.value) : null;
            lsl = lslInput.value ? parseFloat(lslInput.value) : null;
            
            // 计算基本统计量
            const values = dataPoints;
            const n = values.length;
            const mean = values.reduce((sum, val) => sum + val, 0) / n;
            
            // 计算移动极差
            const movingRanges = [];
            for (let i = 1; i < values.length; i++) {
                movingRanges.push(Math.abs(values[i] - values[i-1]));
            }
            
            const meanMR = movingRanges.reduce((sum, val) => sum + val, 0) / movingRanges.length;
            
            // 计算控制限
            const iUCL = mean + (2.66 * meanMR);
            const iLCL = mean - (2.66 * meanMR);
            const mrUCL = 3.27 * meanMR;
            
            // 更新统计数据
            statDataPoints.textContent = n;
            statMean.textContent = mean.toFixed(3);
            statUcl.textContent = iUCL.toFixed(3);
            statLcl.textContent = iLCL.toFixed(3);
            
            // 计算标准差用于分区
            const stdDev = meanMR / 1.128; // d2 = 1.128 for n=2
            
            // 检测八大判异原则
            const ruleViolations = detectRuleViolations(values, mean, stdDev, iUCL, iLCL);
            
            // 更新图表
            updateCharts(values, movingRanges, mean, iUCL, iLCL, meanMR, mrUCL, usl, lsl, ruleViolations);
            
            // 显示结果
            displayResults(values, movingRanges, mean, iUCL, iLCL, meanMR, mrUCL, usl, lsl, ruleViolations);
            
            // 显示通知
            const outlierCount = ruleViolations.filter(v => v.rules.length > 0).length;
            const columnName = document.querySelector(`.header-input[data-col="${currentColumn}"]`).value;
            
            if (outlierCount > 0) {
                document.getElementById('outlier-count').textContent = outlierCount;
                showNotification(`分析已完成（${columnName}），发现 ${outlierCount} 个异常点！`);
            } else {
                showNotification(`分析完成（${columnName}），未发现异常点`, "success");
            }
        }
        
        // 清除图表数据
        function clearCharts() {
            if (iChart) {
                iChart.data.labels = [];
                iChart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                iChart.update();
            }
            
            if (mrChart) {
                mrChart.data.labels = [];
                mrChart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                mrChart.update();
            }
            
            // 重置统计信息
            statDataPoints.textContent = '0';
            statMean.textContent = '0.000';
            statUcl.textContent = '0.000';
            statLcl.textContent = '0.000';
        }
        
        // 检测八大判异原则
        function detectRuleViolations(values, mean, stdDev, iUCL, iLCL) {
            const violations = Array(values.length).fill().map(() => ({rules: []}));
            
            // 只检测启用的规则
            if (enabledRules.includes(1)) {
                // 规则1: 点在控制限外
                for (let i = 0; i < values.length; i++) {
                    if (values[i] > iUCL || values[i] < iLCL) {
                        violations[i].rules.push(1);
                    }
                }
            }
            
            if (enabledRules.includes(2)) {
                // 规则2: 连续9点在中心线同一侧
                for (let i = 0; i <= values.length - 9; i++) {
                    const segment = values.slice(i, i + 9);
                    const allAbove = segment.every(v => v > mean);
                    const allBelow = segment.every(v => v < mean);
                    
                    if (allAbove || allBelow) {
                        for (let j = i; j < i + 9; j++) {
                            if (!violations[j].rules.includes(2)) {
                                violations[j].rules.push(2);
                            }
                        }
                    }
                }
            }
            
            if (enabledRules.includes(3)) {
                // 规则3: 连续6点递增或递减
                for (let i = 0; i <= values.length - 6; i++) {
                    const segment = values.slice(i, i + 6);
                    
                    let increasing = true;
                    let decreasing = true;
                    
                    for (let j = 1; j < segment.length; j++) {
                        if (segment[j] <= segment[j-1]) increasing = false;
                        if (segment[j] >= segment[j-1]) decreasing = false;
                    }
                    
                    if (increasing || decreasing) {
                        for (let j = i; j < i + 6; j++) {
                            if (!violations[j].rules.includes(3)) {
                                violations[j].rules.push(3);
                            }
                        }
                    }
                }
            }
            
            if (enabledRules.includes(4)) {
                // 规则4: 连续14点上下交错
                for (let i = 0; i <= values.length - 14; i++) {
                    const segment = values.slice(i, i + 14);
                    let alternating = true;
                    
                    for (let j = 1; j < segment.length; j++) {
                        // 检查是否上下交替
                        const prevDiff = segment[j-1] - mean;
                        const currDiff = segment[j] - mean;
                        
                        if (prevDiff * currDiff >= 0) {
                            alternating = false;
                            break;
                        }
                    }
                    
                    if (alternating) {
                        for (let j = i; j < i + 14; j++) {
                            if (!violations[j].rules.includes(4)) {
                                violations[j].rules.push(4);
                            }
                        }
                    }
                }
            }
            
            if (enabledRules.includes(5)) {
                // 规则5: 连续3点中有2点在同侧的2σ外
                for (let i = 0; i <= values.length - 3; i++) {
                    const segment = values.slice(i, i + 3);
                    const countAbove = segment.filter(v => v > mean + 2 * stdDev).length;
                    const countBelow = segment.filter(v => v > mean + 2 * stdDev).length;
                    
                    if (countAbove >= 2 || countBelow >= 2) {
                        for (let j = i; j < i + 3; j++) {
                            if ((values[j] > mean + 2 * stdDev) || (values[j] < mean - 2 * stdDev)) {
                                if (!violations[j].rules.includes(5)) {
                                    violations[j].rules.push(5);
                                }
                            }
                        }
                    }
                }
            }
            
            if (enabledRules.includes(6)) {
                // 规则6: 连续5点中有4点在同侧的1σ外
                for (let i = 0; i <= values.length - 5; i++) {
                    const segment = values.slice(i, i + 5);
                    const countAbove = segment.filter(v => v > mean + stdDev).length;
                    const countBelow = segment.filter(v => v < mean - stdDev).length;
                    
                    if (countAbove >= 4 || countBelow >= 4) {
                        for (let j = i; j < i + 5; j++) {
                            if ((values[j] > mean + stdDev) || (values[j] < mean - stdDev)) {
                                if (!violations[j].rules.includes(6)) {
                                    violations[j].rules.push(6);
                                }
                            }
                        }
                    }
                }
            }
            
            if (enabledRules.includes(7)) {
                // 规则7: 连续15点在1σ内
                for (let i = 0; i <= values.length - 15; i++) {
                    const segment = values.slice(i, i + 15);
                    const allInZone = segment.every(v => v >= mean - stdDev && v <= mean + stdDev);
                    
                    if (allInZone) {
                        for (let j = i; j < i + 15; j++) {
                            if (!violations[j].rules.includes(7)) {
                                violations[j].rules.push(7);
                            }
                        }
                    }
                }
            }
            
            if (enabledRules.includes(8)) {
                // 规则8: 连续8点在1σ外
                for (let i = 0; i <= values.length - 8; i++) {
                    const segment = values.slice(i, i + 8);
                    const allOutZone = segment.every(v => v < mean - stdDev || v > mean + stdDev);
                    
                    if (allOutZone) {
                        for (let j = i; j < i + 8; j++) {
                            if (!violations[j].rules.includes(8)) {
                                violations[j].rules.push(8);
                            }
                        }
                    }
                }
            }
            
            return violations;
        }
        
        // 更新图表
        function updateCharts(values, mrValues, mean, iUCL, iLCL, meanMR, mrUCL, usl, lsl, ruleViolations) {
            // 生成标签
            const labels = values.map((_, i) => `样本 ${i + 1}`);
            const mrLabels = mrValues.map((_, i) => `样本 ${i + 2}`);
            
            // 更新单值图数据
            iChart.data.labels = labels;
            iChart.data.datasets[0].data = values;
            iChart.data.datasets[1].data = Array(values.length).fill(mean);
            iChart.data.datasets[2].data = Array(values.length).fill(iUCL);
            iChart.data.datasets[3].data = Array(values.length).fill(iLCL);
            
            // 添加规格限（如果存在）
            if (usl !== null) {
                iChart.data.datasets[4].data = Array(values.length).fill(usl);
            } else {
                iChart.data.datasets[4].data = [];
            }
            
            if (lsl !== null) {
                iChart.data.datasets[5].data = Array(values.length).fill(lsl);
            } else {
                iChart.data.datasets[5].data = [];
            }
            
            // 设置点的背景色（单值图）
            iChart.data.datasets[0].pointBackgroundColor = values.map((_, i) => {
                if (ruleViolations[i].rules.length > 0) {
                    return '#e74c3c'; // 异常点为红色
                }
                return '#4361ee'; // 正常点为蓝色
            });
            
            // 更新移动极差图数据
            mrChart.data.labels = mrLabels;
            mrChart.data.datasets[0].data = mrValues;
            mrChart.data.datasets[1].data = Array(mrValues.length).fill(meanMR);
            mrChart.data.datasets[2].data = Array(mrValues.length).fill(mrUCL);
            
            // 设置点的背景色（移动极差图）
            mrChart.data.datasets[0].pointBackgroundColor = mrValues.map((mr) => {
                return mr > mrUCL ? '#e74c3c' : '#4361ee';
            });
            
            iChart.update();
            mrChart.update();
        }
        
        // 显示分析结果
        function displayResults(values, movingRanges, mean, iUCL, iLCL, meanMR, mrUCL, usl, lsl, ruleViolations) {
            // 统计异常点
            const outlierPoints = [];
            const ruleCounts = Array(8).fill(0);
            
            ruleViolations.forEach((violation, i) => {
                if (violation.rules.length > 0) {
                    outlierPoints.push({
                        index: i + 1,
                        value: values[i],
                        rules: [...violation.rules]
                    });
                    
                    violation.rules.forEach(rule => {
                        ruleCounts[rule-1]++;
                    });
                }
            });
            
            const columnName = document.querySelector(`.header-input[data-col="${currentColumn}"]`).value;
            
            // 构建结果HTML
            let html = `
                <div class="result-item">
                    <h3><i class="fas fa-info-circle"></i> 基本统计信息（${columnName}）</h3>
                    <p>数据点数: <span class="highlight">${values.length}</span></p>
                    <p>平均值(CL): <span class="highlight">${mean.toFixed(3)}</span></p>
                    <p>平均移动极差(MR): <span class="highlight">${meanMR.toFixed(3)}</span></p>
                    <p>标准差估计值: <span class="highlight">${(meanMR / 1.128).toFixed(3)}</span></p>
                </div>
                
                <div class="result-item">
                    <h3><i class="fas fa-chart-line"></i> 控制限计算结果</h3>
                    <p>单值图上控制限(UCL): <span class="highlight">${iUCL.toFixed(3)}</span></p>
                    <p>单值图下控制限(LCL): <span class="highlight">${iLCL.toFixed(3)}</span></p>
                    <p>移动极差图上控制限(UCL): <span class="highlight">${mrUCL.toFixed(3)}</span></p>
                    ${usl !== null ? `<p>上规格限(USL): <span class="highlight">${usl.toFixed(3)}</span></p>` : ''}
                    ${lsl !== null ? `<p>下规格限(LSL): <span class="highlight">${lsl.toFixed(3)}</span></p>` : ''}
                </div>
                
                <div class="result-item">
                    <h3><i class="fas fa-exclamation-triangle"></i> 异常规则统计</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            `;
            
            // 添加规则统计
            for (let i = 0; i < 8; i++) {
                const isEnabled = enabledRules.includes(i+1);
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${isEnabled ? 'var(--primary)' : '#6c757d'};">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: bold; color: ${isEnabled ? '#2c3e50' : '#6c757d'};">规则 ${i+1}</span>
                            <span style="font-size: 1.2rem; font-weight: bold; color: ${ruleCounts[i] > 0 ? '#e74c3c' : '#27ae60'};">${ruleCounts[i]}</span>
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 8px; color: ${isEnabled ? '#495057' : '#6c757d'};">${isEnabled ? '启用中' : '已禁用'}</div>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            
            resultsContainer.innerHTML = html;
            
            // 更新异常点标签内容
            if (outlierPoints.length > 0) {
                let outlierList = '<table style="width:100%; margin-top:15px;"><tr><th>样本</th><th>数值</th><th>触发的规则</th></tr>';
                
                outlierPoints.forEach(point => {
                    const rules = point.rules.map(r => `<span class="rule-violation rule-${r}">规则${r}</span>`).join(' ');
                    outlierList += `
                        <tr>
                            <td>${point.index}</td>
                            <td>${point.value.toFixed(3)}</td>
                            <td>${rules}</td>
                        </tr>
                    `;
                });
                
                outlierList += '</table>';
                
                violationsContainer.innerHTML = `
                    <div class="result-item">
                        <h3><i class="fas fa-search"></i> 异常点详情</h3>
                        <p>共发现 <span class="highlight">${outlierPoints.length}</span> 个异常数据点:</p>
                        ${outlierList}
                    </div>
                `;
            } else {
                violationsContainer.innerHTML = `
                    <div class="result-item">
                        <h3><i class="fas fa-search"></i> 异常点检测</h3>
                        <p>未发现异常数据点</p>
                    </div>
                `;
            }
        }
        
        // 清除数据
        function clearData() {
            inputTableBody.innerHTML = '';
            lockedRows.clear(); // 清除所有锁定行记录
            addDataRow(); // 添加一行空白行
            resultsContainer.innerHTML = '<p>输入数据后分析结果将显示在这里。</p>';
            violationsContainer.innerHTML = '<p>异常点将显示在这里。</p>';
            
            // 重置规格限
            uslInput.value = '';
            lslInput.value = '';
            
            // 清除图表数据
            clearCharts();
            
            dataPoints = [];
            usl = null;
            lsl = null;
            
            showNotification("数据已清除", "info");
        }
        
        // 导出为Excel
        function exportToExcel() {
            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            
            // 准备数据
            const dataForExport = [];
            
            // 添加标题行
            const headers = ['序号'];
            for (let i = 1; i <= columnCount; i++) {
                const headerInput = document.querySelector(`.header-input[data-col="data${i}"]`);
                headers.push(headerInput ? headerInput.value : `数据列${i}`);
            }
            dataForExport.push(headers);
            
            // 添加数据行
            const rows = inputTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const serial = row.querySelector('.serial-col').textContent;
                const dataRow = [serial];
                
                for (let i = 1; i <= columnCount; i++) {
                    const dataInput = row.querySelector(`.data-input[data-col="data${i}"]`);
                    dataRow.push(dataInput ? dataInput.value : '');
                }
                
                dataForExport.push(dataRow);
            });
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(dataForExport);
            
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, ws, "控制图数据");
            
            // 导出Excel文件
            XLSX.writeFile(wb, '多列控制图数据.xlsx');
            
            showNotification("数据已导出为Excel", "success");
        }
        
        // 从Excel导入
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 将工作表转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // 检查数据格式
                    if (jsonData.length < 2) {
                        showNotification("Excel格式不正确，需要至少一行数据", "warning");
                        return;
                    }
                    
                    // 获取表头
                    const headers = jsonData[0];
                    
                    // 根据导入的数据列数更新界面
                    const importedColCount = headers.length - 1; // 减去序号列
                    if (importedColCount > 0) {
                        columnCount = importedColCount;
                        updateColumnCount();
                    }
                    
                    // 更新列名
                    for (let i = 1; i < headers.length; i++) {
                        if (i <= columnCount) {
                            const headerInput = document.querySelector(`.header-input[data-col="data${i}"]`);
                            if (headerInput) {
                                headerInput.value = headers[i];
                                
                                // 更新下拉菜单选项
                                const option = document.querySelector(`#data-column-select option[value="data${i}"]`);
                                if (option) {
                                    option.textContent = headers[i];
                                }
                            }
                        }
                    }
                    
                    // 清除现有数据
                    inputTableBody.innerHTML = '';
                    lockedRows.clear();
                    
                    // 添加数据行
                    for (let i = 1; i < jsonData.length; i++) {
                        const rowData = jsonData[i];
                        if (rowData && rowData.length >= 1) {
                            const row = document.createElement('tr');
                            const rowIndex = i - 1;
                            
                            let rowHTML = `<td class="serial-col">${i}</td>`;
                            
                            for (let j = 1; j <= columnCount; j++) {
                                rowHTML += `<td><input type="number" step="0.01" class="input-cell data-input" data-col="data${j}" value="${rowData[j] || ''}"></td>`;
                            }
                            
                            rowHTML += `
                                <td>
                                    <button class="btn btn-danger delete-row-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                                <td>
                                    <button class="lock-btn" data-row="${rowIndex}">
                                        锁定
                                    </button>
                                </td>
                            `;
                            
                            row.innerHTML = rowHTML;
                            inputTableBody.appendChild(row);
                            
                            // 添加删除行事件
                            const deleteBtn = row.querySelector('.delete-row-btn');
                            deleteBtn.addEventListener('click', function() {
                                if (inputTableBody.children.length > 1) {
                                    // 更新锁定行索引
                                    const rowIndex = parseInt(row.querySelector('.lock-btn').getAttribute('data-row'));
                                    const newLockedRows = new Set();
                                    lockedRows.forEach(lockedIndex => {
                                        if (lockedIndex < rowIndex) {
                                            newLockedRows.add(lockedIndex);
                                        } else if (lockedIndex > rowIndex) {
                                            newLockedRows.add(lockedIndex - 1);
                                        }
                                    });
                                    lockedRows = newLockedRows;
                                    
                                    row.remove();
                                    updateSerialNumbers();
                                    calculateControlLimits();
                                } else {
                                    showNotification("至少需要保留一行数据", "warning");
                                }
                            });
                            
                            // 添加锁定行事件
                            const lockBtn = row.querySelector('.lock-btn');
                            lockBtn.addEventListener('click', function() {
                                const rowIndex = parseInt(this.getAttribute('data-row'));
                                
                                if (lockedRows.has(rowIndex)) {
                                    // 解锁行
                                    lockedRows.delete(rowIndex);
                                    this.classList.remove('locked');
                                    this.textContent = '锁定';
                                    
                                    // 启用该行的所有输入框
                                    row.querySelectorAll('.data-input').forEach(input => {
                                        input.disabled = false;
                                    });
                                } else {
                                    // 锁定行
                                    lockedRows.add(rowIndex);
                                    this.classList.add('locked');
                                    this.textContent = '解锁';
                                    
                                    // 禁用该行的所有输入框
                                    row.querySelectorAll('.data-input').forEach(input => {
                                        input.disabled = true;
                                    });
                                }
                            });
                            
                            // 添加回车键跳转功能
                            row.querySelectorAll('.data-input').forEach((input, index, inputs) => {
                                input.addEventListener('keydown', function(e) {
                                    if (e.key === 'Enter') {
                                        e.preventDefault();
                                        
                                        // 找到下一个输入框
                                        let nextInput;
                                        if (index < inputs.length - 1) {
                                            // 同一行的下一个输入框
                                            nextInput = inputs[index + 1];
                                        } else {
                                            // 下一行的第一个输入框
                                            const nextRow = row.nextElementSibling;
                                            if (nextRow) {
                                                nextInput = nextRow.querySelector('.data-input');
                                            } else {
                                                // 如果没有下一行，添加新行并聚焦到第一个输入框
                                                const newRow = addDataRow();
                                                setTimeout(() => {
                                                    newRow.querySelector('.data-input').focus();
                                                }, 10);
                                                return;
                                            }
                                        }
                                        
                                        // 聚焦到下一个输入框
                                        if (nextInput && !nextInput.disabled) {
                                            nextInput.focus();
                                            nextInput.select();
                                        }
                                    }
                                });
                            });
                        }
                    }
                    
                    // 添加一个空白行
                    addDataRow();
                    
                    // 自动计算
                    setTimeout(calculateControlLimits, 500);
                    showNotification("Excel数据导入成功", "success");
                    
                } catch (error) {
                    console.error("Excel导入错误:", error);
                    showNotification("Excel导入失败: " + error.message, "warning");
                }
                
                // 重置文件输入
                event.target.value = '';
            };
            
            reader.onerror = function() {
                showNotification("文件读取失败", "warning");
                event.target.value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 显示通知
        function showNotification(message, type = "success") {
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle"></i> ${message}`;
            notification.style.background = type === 'success' ? '#4cc9f0' : 
                                          type === 'warning' ? '#f39c12' : 
                                          type === 'info' ? '#4895ef' : '#e63946';
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 添加本地库状态检查功能
        function checkLibraryStatus() {
            // 检查SheetJS
            if (typeof XLSX !== 'undefined') {
                document.getElementById('xlsx-status').className = 'status-icon status-ok';
                document.getElementById('xlsx-status').textContent = '✓';
                document.getElementById('xlsx-version').textContent = '已加载';
            } else {
                document.getElementById('xlsx-status').className = 'status-icon status-error';
                document.getElementById('xlsx-status').textContent = '✗';
                document.getElementById('xlsx-version').textContent = '未加载';
            }
            
            // 检查Chart.js
            if (typeof Chart !== 'undefined') {
                document.getElementById('chartjs-status').className = 'status-icon status-ok';
                document.getElementById('chartjs-status').textContent = '✓';
                document.getElementById('chartjs-version').textContent = '已加载';
            } else {
                document.getElementById('chartjs-status').className = 'status-icon status-error';
                document.getElementById('chartjs-status').textContent = '✗';
                document.getElementById('chartjs-version').textContent = '未加载';
            }
            
            // 检查Font Awesome
            const faCheck = document.createElement('i');
            faCheck.className = 'fas fa-check';
            document.body.appendChild(faCheck);
            const faStyle = window.getComputedStyle(faCheck, '::before');
            const faLoaded = faStyle && faStyle.content && faStyle.content !== 'none';
            document.body.removeChild(faCheck);
            
            if (faLoaded) {
                document.getElementById('fontawesome-status').className = 'status-icon status-ok';
                document.getElementById('fontawesome-status').textContent = '✓';
                document.getElementById('fontawesome-version').textContent = '已加载';
            } else {
                document.getElementById('fontawesome-status').className = 'status-icon status-error';
                document.getElementById('fontawesome-status').textContent = '✗';
                document.getElementById('fontawesome-version').textContent = '未加载';
            }
        }
        
        // 添加切换显示/隐藏功能
        document.getElementById('toggle-status-btn').addEventListener('click', function() {
            const statusList = document.getElementById('lib-status-list');
            const isHidden = statusList.style.display === 'none';
            
            if (isHidden) {
                statusList.style.display = 'block';
                this.textContent = '隐藏';
            } else {
                statusList.style.display = 'none';
                this.textContent = '显示';
            }
        });
        
        // 在DOM加载完成后检查库状态
        document.addEventListener('DOMContentLoaded', function() {
            // 原有初始化代码
            
            // 添加库状态检查
            setTimeout(checkLibraryStatus, 1000); // 延迟1秒检查，确保所有库已加载
        });
    </script>
</body>
</html>